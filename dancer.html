<head>
    <title>Dansr</title>
    <!--this is bootstrap if you want it-->
    <link rel="stylesheet" href= "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">

    <link rel="stylesheet" href="mainLayout.css">
    <link rel='shortcut icon' href='images/dicon.ico'/>


  <!-- jQuery and jQueryUI -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="js/ui/jquery.ui.draggable.js" type="type/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script>
    var secEnd = 1;
    var secStart = 0;
    var loop = false;
    var pause = false;
    var isPlaying = false;

    this.playIndicator = function() {
      var rect = document.getElementById("seekbar").getBoundingClientRect();
      if (secStart >= secEnd) {
        console.log("play with handles reversed: " + secEnd + "-" + secStart);
        if (!pause) {
          $("#indicator").css({
            "left": $("#sectionEnd").position().left-rect.left-5
          });
        }
        $("#indicator").animate({
          "left": $("#sectionStart").position().left-rect.left-5
        }, (secStart-secEnd)*30000, "linear");

      } else {
        console.log("play: " + secStart + "-" + secEnd);
        if (!pause) {
          $("#indicator").css({
            "left": $("#sectionStart").position().left-rect.left-5
          });
        }
        $("#indicator").animate({
          "left": $("#sectionEnd").position().left-rect.left-5
        }, (secEnd-secStart)*30000, "linear");
      }
      setTimeout(function() {
        console.log("here");
        if (loop) {
          playIndicator();
        } 
      }, Math.abs(secStart-secEnd)*30000 + 50);
    }

    
    $(document).ready(function() {

      //Initialize auto-complete
      var availableCodes = [
        "chicken",
        "toffee",
        "nature",
      ];


      // TODO(ap) get rid of global variable
      $( "#codeSearch" ).autocomplete({
          source: availableCodes
      });

      $('#codeSubmit').click(function() {
      //TODO: Prevent multiple entries from being added

        //Add entered code to auto-complete list:
        availableCodes.push($('#codeSearch').val());

        //$( "#codeSearch" ).val(""); //Uncomment to clear text field

        $( "#codeSearch" ).autocomplete({
            source: availableCodes
        });

        //TODO:  Advance to next screen after searching for dance code
      });

      //Draggable Indicator:
      $(function() {
        $("#indicator").draggable({ axis: "x", containment: "parent"});
        $("#indicator").on("drag", function(event, ui) {
          $("#indicator").stop();
          var width = $("#seekbar").width();
          var fractionalPosition = ui.position.left / width;

           //TODO: Trigger seek in video / audio
        });
      });

      //Draggable Handlebars
      

      $(".handlebar").mousedown(function(event) {
        event.stopPropagation();
      });

      $(function() {
        var rect = document.getElementById("seekbar").getBoundingClientRect();
        $(".handlebar").draggable({ axis: "x", containment: "parent"});
        $("#sectionStart").css({"position": "relative", "left": 0});
        $("#sectionEnd").css({"position": "relative", "left": rect.right-rect.left-20});
        $(".handlebar").on("drag", function(event, ui) {
          var width = $("#seekbar").width();
          var fractionalPosition = ui.position.left / width;
          if ($(this).attr("id") == "sectionEnd") {
            secEnd = fractionalPosition;
          } else {
            secStart = fractionalPosition;
          }
        });
      });

      $("#seekbar").mousedown(function(event) {
        $("#indicator").stop();
        var clickedPosX_centered = event.clientX - event.delegateTarget.offsetLeft - $('#indicator').width();
        //Adjust to 0 if negative to avoid glitches:
        if(clickedPosX_centered < 0) {
         clickedPosX_centered = 0;
        }
        $("#indicator").css({ position: 'relative',
          left: clickedPosX_centered });

        var indicator = $("#indicator");

        indicator.triggerHandler(event);

        });

      //Valume control
      //Draggable volumeIndicator:
      $(function() {
        $("#volumeIndicator").draggable({ axis: "x", containment: "parent"});
        $("#volumeIndicator").on("drag", function(event, ui) {
          var width = $("#volumeBar").width();
          var fractionalPosition = ui.position.left / width;

           //TODO: Trigger seek in video / audio
        });
      });

      $("#volumeBar").mousedown(function(event) {
        var clickedPosX_centered = event.clientX - event.delegateTarget.offsetLeft - $('#volumeIndicator').width();
        //Adjust to 0 if negative to avoid glitches:
        if(clickedPosX_centered < 0) {
          clickedPosX_centered = 0;
        }
        $("#volumeIndicator").css({ position: 'relative',
                              left: clickedPosX_centered });

        var volumeIndicator = $("#volumeIndicator");

        volumeIndicator.triggerHandler(event);
      });

      $(document).on('click', "#loop", function(evt)
      {
        loop = !loop;
      });

      $(document).on('click', "#replay", function(evt)
      {
        $("#indicator").stop();
        playIndicator();
      });

    $(document).on('click', "#playPause", function(evt)
    {
      var button  = document.getElementById("playPause") // maybe this instead?
      if (!isPlaying){
        console.log("play:")
        var video = document.getElementById("videoBox");
        video.play();
        isPlaying = true;
        playIndicator();
        pause = false;
        // set button to pause
        button.setAttribute("style", "background-image:url('images/pause.svg')")
      } else {
        console.log("pause:")
        var video = document.getElementById("videoBox");
        video.pause();
        $("#indicator").stop();
        pause = true;
        // set button to play
        button.setAttribute("style", "background-image:url('images/play.svg')")
        isPlaying = false;

      }
    });

  });

    </script>
</head>


<body>
    <!-- <h1> This is an awesome Dancer interface</h1> -->
    <div id ="top">
        <!-- this is for the hamburger menu, logo, and watch/edit dance button-->
        <a href="homepage.html" id="logo">Dancer</a>
        <a href="choreo.html" id="editDance">Edit Dance</a>
    </div>

    <div id ="search">
  <div class="ui-widget" id="searchWidget">
    <label for="codeSearch">Enter Code:</label>
    <input id="codeSearch" class="ui-autocomplete-input" >
    <button id="codeSubmit">Submit</button>
    </div>
    </div>

    <div id="content" style="width:80%; margin: 0 auto">
    <div id="video">
      <!-- https://www.w3schools.com/html/html5_video.asp -->
      <video id="videoBox">
  <source src="images/Exercise1949_512kb.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>
    </div>

      <div id ="seekbar">
         <div id="sectionStart" class="ui-draggable ui-draggable-handle handlebar"></div>
         <div id="indicator" class="ui-draggable ui-draggable-handle"></div>
         <div id="sectionEnd" class="ui-draggable ui-draggable-handle handlebar"></div>
      </div>

      <div class="btn-group" id="toolbar">
        <button type="button" class="btn btn-primary tool-icon" id="playPause" style="background-image:url('images/play.svg')"/>

        <button type="button" class="btn btn-primary tool-icon" id="replay" style="background-image:url('images/replay.svg')"/>
        <button type="button" class="btn btn-primary tool-icon" id="loop" style="background-image:url('images/loop.svg')"/>
        <button type="button" class="btn btn-primary tool-icon" id="left" style="background-image:url('images/left.svg')"/>

        <!-- TODO(AP) make speed look more like a text box in the toolbar like in our prototype-->
        <button type="button" class="btn btn-primary tool-icon" id="speed">1.0</button>
        <button type="button" class="btn btn-primary tool-icon" id="right" style="background-image:url('images/right.svg')"/>
        <button type="button" class="btn btn-primary tool-icon" style="background-image:url('images/gear.png')"/>

        <!-- TODO(AP) make not a button, but still look nice -->
        <button type="button" class="btn btn-primary tool-icon" id="volume" style="background-image:url('images/volume.svg')">  </button>

        <div id ="volumeBar">
          <div id="volumeIndicator" class="ui-draggable ui-draggable-handle" style="zIndex:3;"></div>
        </div>
        <button type="button" class="btn btn-primary tool-icon" style="background-image:url('images/fullscreen.svg')"/>

      </div>
    </div>



</body>
