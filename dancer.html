ad>
  <title>Dansr</title>
  <!--this is bootstrap if you want it-->
  <link rel="stylesheet" href= "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">

  <link rel="stylesheet" href="mainLayout.css">
  <link rel='shortcut icon' href='images/dfavicon.png'/>
  <meta charset="UTF-8">


  <!-- jQuery and jQueryUI -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="js/ui/jquery.ui.draggable.js" type="type/javascript"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <script>
  /************************ Global Variables ********************/
  // TODO() replace as many as possible with functions.
  // i.e isLoopOn should be a function that reads the state of the loop button
  // as opposed to something we trust ourselves to modify correctly and consistently


  var isLoopOn = false;
  var isMetronomeOn = false;

  // to turn of debugging statements
  var debugOn = false;

  //Initialize auto-complete
  var availableCodes = [
    "chicken",
    "toffee",
    "nature",
  ];

  var COUNTOFF_MIN=0;
  var COUNTOFF_MAX=30;
  var countoff = 0;

  var SPEED_MIN=0.5;
  var SPEED_MAX=4.0;

  // play indicator global Variables
  var indicatorTimeout = 100;
  var global_counter;
  var startLoop = false;

  var isMuteOn = false;
  var prevVol = 0.5;

  /************************ Helper Functions ********************/

  // function that plays the video starting at percentage
  // percentage: integer in range [0,100] represents percentage into the video thot the video should be started at
  // returns: null
  loopVideoTo = function(percentage){
    var video = getVideo();
    video.currentTime = (percentage/100.) * video.duration;

    // check if we need to play the video
    // this is needed when we end the video, and then move the indicator back.
    if (isPlayOn() && video.paused) {
      video.play()
    }
  }

  // sets the speed of the video
  // speed: a positive  floating point number that represents the speed of video
  // i.e speed=.5 plays the video at half times speed, speed=2 plays at twice the speed
  setVideoSpeed = function(speed){
    var video = getVideo();
    video.playbackRate = speed
  }

  // may or may not actually correspond to the actual video speed,
  // isn't life wonderful?
  getSpeed = function(){
    var speed = $("#speed").val();
    return speed;
  }

  // gets the length of the video in seconds
  getVideoDuration = function(){
    return getVideo().duration;
  }

  // get the currentTime of the video
  getVideoTime = function(){
    return getVideo().currentTime;
  }

  // return the width of the seekbar
  getSeekbarWidth = function(){
    return $('#seekbar').width();
  }

  // get the video dom object
  getVideo = function(){
    return document.getElementById("videoBox");
  }

  pauseVideo = function(){
    var video = getVideo();
    video.pause();
  }

  playVideo = function(){
    var video = getVideo();
    video.play();
  }

  // returns the string representation of countoff which is just
  // " (number)s"
  // note the preceding space
  // length of string is padded to 4 characters with a space
  countoffToString = function() {
    var toString = '&nbsp' + countoff + "s";
    if (countoff < 10){
      toString = '&nbsp' + '   ' + countoff + "s";
    }
    return toString;
  }

  pixelToFloat = function(left){
    return parseFloat(left.substring(0, left.length - 2));
  }

  // TODO: positons of everything isn't consistent, some have to be offset with seekbarWidth
  // sad!
  // get left position of the play Indicator
  getIndicatorPosition = function() {
    var left = document.getElementById("indicator").style.left;
    return pixelToFloat(left);
  }
  // set left position of the play Indicator to left
  setIndicatorPosition = function(left) {
    var indicator = document.getElementById("indicator").style;
    indicator.left = left;
    debug("value is here: " + indicator.left);
  }
  // get left position of the start handle
  getHandleStartPosition = function() {
    // TODO call sectionStart a better name...
    var left = document.getElementById("sectionStart").style.left;
    return pixelToFloat(left);
  }
  setHandleStartPosition = function(left) {
    document.getElementById("sectionStart").style.left = left;
  }
  // get left position of the end handle
  getHandleEndPositon = function() {
    var left = document.getElementById("sectionEnd").style.left;
    return getSeekbarWidth() + pixelToFloat(left);
  }

  setHandleEndPosition = function(left) {
    document.getElementById("sectionEnd").style.left = left - getSeekbarWidth();
  }

  getNextPosition = function(current, handleStart, handleEnd) {
    // 1000 because videoDuration is in seconds, and we work in milliseconds
    var steps = 1000*getVideoDuration()/ indicatorTimeout;
    var delta = getSpeed() * getSeekbarWidth() / steps;
    debug(delta);
    var nextJump = current + delta;
    // this controls whether or not we want to start in the beggining or not
    if (nextJump > handleEnd && isLoopOn) {
      return handleStart;
    } else if (nextJump > handleEnd && !isLoopOn) {
      return handleEnd;
    } else if (nextJump < handleStart) {
      return handleStart;
    } else {
      return nextJump;
    }
  }

  getCountOff = function() {
    var countoff = document.getElementById("countoffBar");
    return countoff.value;
  }

  // gets the volume from the volume slider
  setVolume = function() {
    var volume = document.getElementById("volumeBar");
    var button = document.getElementById("volume");
    getVideo().volume = volume.value / 100;
    if (volume.value == 0) {
      button.setAttribute("style", "background-image:url('images/volume_off.svg')")
      isMuteOn = true;
    } else {
      button.setAttribute("style", "background-image:url('images/volume_on.svg')")
      isMuteOn = false;
    }
  }

  var continuePlayIndicator; //to enable cancelling of the interval

  // does all the side effects associated with pausing
  pause = function() {
  	clearInterval(continuePlayIndicator);
    pauseVideo();
    document.getElementById("playPause").setAttribute("style", "background-image:url('images/play.svg')")
  }

  // does all the side effects associated with playing a video
  play = function() {
    continuePlayIndicator = setInterval(playIndicator, indicatorTimeout);
    playVideo();
    document.getElementById("playPause").setAttribute("style", "background-image:url('images/pause.svg')")
  }

  isPlayOn = function() {
    return document.getElementById("playPause").getAttribute("style") == "background-image:url('images/pause.svg')";
  }
  // debugger
  debug = function(string){
    if (debugOn) {
      console.log(string)
    }
  }
  /******************* Event Handlers *******************/

	var continueCountoffIndicator; //prevents infinite loop of checkCountOff()

  // pauses the video while the countoff happens
  this.checkCountOff = function() {
    clearInterval(continueCountoffIndicator);
    var video = getVideo();
    if (startLoop) {
      video.pause();
    } else if (isPlayOn() && video.paused) {
      video.play();
    }
  }

  //starts the countoff procedure
  this.startCountOff = function() {
    continueCountoffIndicator = setInterval(checkCountOff, indicatorTimeout);
    global_counter = 0;
    var timerID = setInterval(function(){
      global_counter++;
      if (global_counter >= getCountOff()) {
        startLoop = false;
        clearInterval(timerID);
      }
    }, 1000);
  }

  // moves the indicator after pressing the play button
  playIndicator = function() {
    // check if we are playing.
    console.log("in playIndicator")
    if (!isPlayOn() || startLoop) {
      console.log("play is off")
      return;
    } else {
      var rect = document.getElementById("seekbar").getBoundingClientRect();
      var handleStart = getHandleStartPosition();
      var handleEnd = getHandleEndPositon();
      var current = getIndicatorPosition();
      var nextCurrent = getNextPosition(current, handleStart, handleEnd)
      setIndicatorPosition(nextCurrent);
      // only happnens when we loop back...
      // so change video
      // we only want to update video in this case, because if we always update
      // video to match, video will look jumpy
      if (nextCurrent == handleEnd){
        pause();
        return;
      }
      if (nextCurrent == handleStart){
        if (getCountOff() > 0) {
          startLoop = true;
        }
        loopVideoTo(100*nextCurrent/getSeekbarWidth());
        startCountOff();
      }

      // TODO: fix the handlebars so that they cannot cross each other
    }
  }

  $(document).ready(function() {
    countoff = this.value;

    // set initial positions of window panes
    $("#formations").css({position: "absolute", left: "70%", top: 170});
    $("#comments").css({position: "absolute", left: "47%", top: 520});

    // set countoff display
    document.getElementById("countoff").innerHTML = "&nbsp0s";
    document.getElementById("videoBox").setAttribute("width", "100%")

    /// set the left of the indicator because things are sketchy
    setIndicatorPosition(0);
    setHandleStartPosition(0);
    setHandleEndPosition(getSeekbarWidth());

    setVolume();

    $(".cross").hide();
    $(".menu").hide();
  });

  $( "#codeSearch" ).autocomplete({
    source: availableCodes
  });

  $('#codeSearch').keypress(function(e) {
    //TODO: Prevent multiple entries from being added
    if(e.which == 13) { // keycode of return is 13
      //Add entered code to auto-complete list:
      availableCodes.push($('#codeSearch').val());

      $( "#codeSearch" ).val(""); //clear text field
      $( "#codeSearch" ).autocomplete({
        source: availableCodes
      });
    }
  });


  //Draggable Indicator:
  $(function() {

    // Set all instances of .draggable-wrapper to be draggable in the body
  	$('.draggable-wrapper').draggable({ containment: "parent" });


		$(".pane").hover(function() {
      $(this).css('cursor','-webkit-grab');
      $(this).css('cursor','-moz-grab');
    }, function() {
    	$(this).css('cursor','auto');
		});

		$('.pane').on('mousedown', function(event) {
    	$(this).css({cursor: "-webkit-grabbing"});
    	$(this).css({cursor: "-moz-grabbing"});
  	});

		$('.pane').on('mouseup', function(event) {
    	$(this).css({cursor: "-webkit-grab"});
    	$(this).css({cursor: "-moz-grab"});
  	});

  	$("#indicatorBar").hover(function() {
    	$(this).css('cursor','col-resize');
		}, function() {
    	$(this).css('cursor','auto');
		});

		$(".handlebar").hover(function() {
    	$(this).css('cursor','col-resize');
		}, function() {
    	$(this).css('cursor','auto');
		});

    toggleXIcon = function(documentId) {
      var xIcon = document.getElementById(documentId);
      if (xIcon.getAttribute("src") == "images/visibility_on.svg") {
        var off = "off"
      } else {
        var off = "on"
      }
      xIcon.setAttribute("src", "images/visibility_" + off + ".svg")
    }
  	// Collapse / Expand window panes:
  	// TODO: Merge into one listener?
		$('#x_button_form').on('mousedown', function(event) {
    	$("#formation-image-wrapper").slideToggle('slow', function() {})
      //toggleXIcon("x_button_form")
  	});

  	$('#x_button_comments').on('mousedown', function(event) {
    	$("#comments-pane").slideToggle('slow', function() {});
  	});

  	$('.x_button').on('mousedown', function(event) {
      toggleXIcon(event.target.id)
  	});

    //$("#indicator").css({right: 0});
    $("#indicator").draggable({ axis: "x", containment: "parent"});
    $("#indicator").on("drag", function(event, ui) {
      $("#indicator").stop();
      var width = $("#seekbar").width();
      var fractionalPosition = Math.abs(ui.position.left / width);
      loopVideoTo(fractionalPosition * 100.);
    });
  });

  //Draggable Handlebars

  // prevents the movement of the indicator when dragging the handlebar
  $(".handlebar").mousedown(function(event) {
    event.stopPropagation();
  });

  // creates the handler for dragging handlebars
  $(function() {
    var rect = document.getElementById("seekbar").getBoundingClientRect();
    $(".handlebar").draggable({ axis: "x", containment: "parent"});

    // updates the grey rectangles on the sides of the handlebar
    // DISCUSS: inverting the greyed out section?
    $(".handlebar").on("drag", function(event, ui) {
      var width = $("#seekbar").width();
      var fractionalPosition = ui.position.left / width;
      if ($(this).attr("id") == "sectionEnd") {
        var handle = document.getElementById("sectionEnd").getBoundingClientRect();
        secEnd = fractionalPosition;
        $("#grayRight").css({"left": ui.position.left+20, "width": rect.right-handle.left-10});
      } else {
        secStart = fractionalPosition;
        $("#grayLeft").css({"width": ui.position.left});
      }
      event.stopPropagation();
    });

    $("#seekbar").on("mousedown", function(event) {
      startLoop = false;
      $("#indicator").stop();
      var clickedPosX_centered = event.clientX - event.delegateTarget.offsetLeft - $('#indicator').width()*1.0;

      //Keep in bounds:
      if(clickedPosX_centered < 0) {
        clickedPosX_centered = 0;
      }
      else if(clickedPosX_centered > $("#seekbar").width()) {
      	clickedPosX_centered = $("#seekbar").width();
      }

      //Make sure indicator doesn't jump if handlebar is clicked:
      if(event.target.id !== "handlebarleft" && event.target.id !== "handlebarright") {
        $("#indicator").css({ left: clickedPosX_centered });
        loopVideoTo( clickedPosX_centered / $("#seekbar").width() * 100.);
      }

    });
  });

  //Volume control
  $(document).on('input', "#volumeBar", function(event) {
    setVolume();
  });

  $(document).on('click', "#volume", function(event) {
    console.log("mute");
    var volume = document.getElementById("volumeBar");
    isMuteOn = !isMuteOn;
    if (isMuteOn) {
      prevVol = volume.value / 100;
      volume.value = 0;
    } else {
      volume.value = prevVol * 100;
    }
    setVolume();
  });

  // back to beginning button - stops the indicator movement and plays again
  $(document).on('click', "#goBack", function(evt)
  {
    setIndicatorPosition(getHandleStartPosition());
    loopVideoTo(100*getHandleStartPosition()/getSeekbarWidth());

    if (getCountOff() > 0) {
      startLoop = true;
      startCountOff();
    }
  });

  $(document).on('click', "#playPause", function(evt)
  {
    startLoop = false;
    console.log("playon: " + isPlayOn);
    if (!isPlayOn()){
      play();
      if (getCountOff() > 0 && Math.abs(getHandleStartPosition()-getIndicatorPosition()) < 0.17) {
        startLoop = true;
        startCountOff();
      }
    } else {
      pause();
      $("#indicator").stop();
    }
  });

  // snaps the handlebars to the section boundaries
  $(document).on('dblclick', ".section", function(evt) {
    startLoop = false;
    var rect = document.getElementById("seekbar").getBoundingClientRect();
    var left = $(this).position().left;
    var right = left + $(this).width() - 20;
    var handle = document.getElementById("sectionEnd").getBoundingClientRect();
    secEnd = right / $("#seekbar").width();
    secStart = left / $("#seekbar").width();
    $("#grayRight").css({"left": right+20, "width": rect.right-handle.left-10});
    $("#grayLeft").css({"width": left});
  });

  $(document).on('mousemove', "#countoffBar", function(evt){
    // set countoff
    countoff = this.value;

    // set countoff display
    document.getElementById("countoff").innerHTML = countoffToString();
  })

  $( function() {
    $( "#slider" ).slider();
  } );

  //Toggles the metronome mode so that the button's background is blue when on, gray when off
  $(document).on('click', '#metronome', function (evt) {
    metronomeButton = document.getElementById("metronome");
    if (isMetronomeOn) {
      isMetronomeOn = false;
      metronomeButton.setAttribute("style", "background-image:url('images/metronome.svg');background-color:lightgray;");
    }
    else {
      isMetronomeOn = true;
      metronomeButton.setAttribute("style", "background-image:url('images/metronome.svg');background-color:#0275d8;border-color:#0275d8")
    }
  });

  //Toggles the loop mode so that the button's background is blue when on, gray when off
  $(document).on('click', '#loop', function (evt) {
    loopButton = document.getElementById("loop");
    if (isLoopOn) {
      isLoopOn = false;
      loopButton.setAttribute("style", "background-image:url('images/loop.svg');background-color:lightgray;");
    }
    else {
      isLoopOn = true;
      loopButton.setAttribute("style", "background-image:url('images/loop.svg');background-color:#0275d8;border-color:#0275d8")
    }
  });

  // SPEED:
  var last_valid_speed = "1.0";

  var clicking = false; //true while either button is held down

  // decrements speed by 0.1
  $(document).on('click', "#speedMinus", function(evt) {
    var speed = $("#speed").val();
    var re = /\d?\.?\d+x?/;

    if(re.test(speed)) { //valid speed string
			speed = parseFloat(speed) - 0.1;
			speed = Math.max(speed, SPEED_MIN);
			speed = Math.min(speed, SPEED_MAX);
			last_valid_speed = speed;
    }

    $("#speed").val(last_valid_speed.toFixed(1.));

    setVideoSpeed(last_valid_speed);

    if(clicking) {
      setTimeout(function() {
    	  $("#speedMinus").click();
    	}, 275);
    }
  });

  $(document).on('mousedown', "#speedMinus", function(evt) {
  		clicking = true;
  		setTimeout(function() {
  			if(clicking) {
    		  $("#speedMinus").click();
    		}
    	}, 275);
  });
  $(document).on('mouseup', "#speedMinus", function(evt) {
      clicking = false;
  });

  // increments speed by 0.1
  $(document).on('click', "#speedPlus", function(evt) {
    var speed = $("#speed").val();
    var re = /\d?\.?\d+x?/;

    if(re.test(speed)) { //valid speed string
			speed = parseFloat(speed) + 0.1;
			speed = Math.max(speed, SPEED_MIN);
			speed = Math.min(speed, SPEED_MAX);
			last_valid_speed = speed;
    }

    $("#speed").val(last_valid_speed.toFixed(1.));

    setVideoSpeed(last_valid_speed);

    if(clicking) {
      setTimeout(function() {
    		$("#speedPlus").click();
    	}, 275);
    }
  });

    $(document).on('mousedown', "#speedPlus", function(evt) {
  		clicking = true;
  		setTimeout(function() {
  			if(clicking) {
    		  $("#speedPlus").click();
    		}
    	}, 275);
  });
  $(document).on('mouseup', "#speedPlus", function(evt) {
      clicking = false;
  });

  $(document).on('keyup', "#speed", function(evt) {
    var speed = $("#speed").val();

    var re = /\d?\.?\d+x?/;

    if(re.test(speed)) { //valid speed string
			speed = parseFloat(speed);
			speed = Math.max(speed, SPEED_MIN);
			speed = Math.min(speed, SPEED_MAX);
			last_valid_speed = speed;
    }

    setVideoSpeed(last_valid_speed);
  });


  // stops enter from submitting the page when focused on the speed textbox
  $(document).on('keypress', "#speed", function (e) {
    if (e.charCode==13) {
      return false;
    }
  });

  //Hamburger menu code
  $(document).on('click', '#hamburger', function (evt) {
      $(".menu").slideToggle("fast", function () {
      });
  });

  </script>
</head>


<body>
  <!-- <h1> This is an awesome Dancer interface</h1> -->
  <div id ="top">
    <!-- this is for the hamburger menu, logo, and watch/edit dance button-->
    <button id="hamburger">
      <img src="https://cdn4.iconfinder.com/data/icons/wirecons-free-vector-icons/32/menu-alt-512.png" width="30px" height="30px">
    </button>
    <a href="homepage.html" id="logo"><img src="images/dansrlogo.svg" height="40"/></a>

    <button class="btn" id="editDance" onclick="location.href='choreo.html'">
      <img src="images/edit.svg">
      <div id="editDanceText">
        Edit Dance
      </div>
    </button>    </div>
    <!--Hamburger menu dropdown-->
    <div class="menu">
        <ul>
            <a href="#"><li><img class="menuSymbol" src="images/plus.svg">Create Dance</li></a>
            <a href="#"><li><img class="menuSymbol" src="images/history.svg">Recently Watched</li></a>
            <a href="#"><li><img class="menuSymbol" src="images/star.svg">Favorites</li></a>
        </ul>
    </div>
    <div id ="search">
      <div class="ui-widget" id="searchWidget">
        <input id="codeSearch" class="ui-autocomplete-input" placeholder="Dance Code: Chicken Dance">
      </div>
    </div>

    <div id="content" style="max-width:999px; margin-top:10; margin-left:auto; margin-right:auto">
      <div id="video">
        <!-- https://www.w3schools.com/html/html5_video.asp -->
        <video id="videoBox">
          <source src="images/chicken.MOV">
            Your browser does not support the video tag.
          </video>
        </div>

        <div id ="seekbar">

          <div id="indicator" class="ui-draggable ui-draggable-handle disable-selection">
            <img id="indicatorBar" src="images/seekbar.svg">
          </div>

          <div id="sectionStart" class="ui-draggable ui-draggable-handle handlebar disable-selection">
            <img id="handlebarleft" src="images/handlebarright.svg">
          </div>

          <div id="sections">
            <div id="section1" class="section"></div>
            <div id="section2" class="section"></div>
            <div id="section3" class="section"></div>
          </div>

          <div id="sectionEnd" class="ui-draggable ui-draggable-handle handlebar disable-selection">
            <img id="handlebarright" src="images/handlebarleft.svg">
          </div>
        </div>


        <!--The toolbar controlling playback controls-->
        <div class="btn-group" id="toolbar">
          <button type="button" class="btn btn-primary tool-icon" id="playPause" style="background-image:url('images/play.svg')" data-toggle="tooltip" data-placement="bottom" title="Play"/>
          <button type="button" class="btn btn-primary tool-icon" id="goBack" style="background-image:url('images/previous.svg')" data-toggle="tooltip" data-placement="bottom" title="Back to beginning of Selection"/>
          <button type="button" class="btn btn-primary tool-icon" id="loop" style="background-image:url('images/loop.svg')" data-toggle="tooltip" data-placement="bottom" title="Loop Selection"/>
          <button type="button" class="btn btn-primary tool-icon" id="speedMinus" style="background-image:url('images/minus.svg')" data-toggle="tooltip" data-placement="bottom" title="Decrease Speed">
          </button>
          <!-- TODO(AP) make speed look more like a text box in the toolbar like in our prototype-->
          <!--The speed controller-->
          <form>
            <div class="form-group form-inline" style="display:inline-block">
              <label for="speed" id="speedLabel" class="disable-selection" style="line-height:1.1">Speed</label>
              <input class="form-control" id="speed" autocomplete="off" value="1.0">
            </div>
          </form>
          <button type="button" class="btn btn-primary tool-icon" id="speedPlus" style="background-image:url('images/plus.svg')">
          </button>

          <div style="display: inline-block">
            <div style="display: flex; margin-bottom: -3px">
              <label id="countoffLabel" class="disable-selection">Start delay:&#160;</label>
              <div id="countoff">&#160 0s</div>
            </div>
            <input id="countoffBar" type="range" min="0" max="30" step="1" value="0"></input>
          </div>

          <button type="button" class="btn btn-primary tool-icon" id="metronome" style="background-image:url('images/metronome.svg')" data-toggle="tooltip" data-placement="bottom" title="Toggle Metronome"/>

          <!-- TODO(AP) make not a button, but still look nice -->
          <button type="button" class="btn btn-primary tool-icon" id="volume" style="background-image:url('images/volume.svg'); margin-left:auto" data-toggle="tooltip" data-placement="bottom" title="Volume">	</button>

          <input id ="volumeBar" type="range" min="0" max="100" step="1"></input>
          <button type="button" class="btn btn-primary tool-icon" id="fullscreen" style="background-image:url('images/fullscreen.svg'); margin-left:auto;" data-toggle="tooltip" data-placement="bottom" title="Fullscreen"/>

        </div>
      </div>

      <!-- Formation Diagram Pane-->
      <div id="formations" class="draggable-wrapper ui-draggable ui-draggable-handle">
        <div id="formation-toolbar" class="toolbar-pane"><p>Formation</p><img id="x_button_form" class="x_button" src="images/visibility_on.svg"/></div>
        <div id="formation-image-wrapper" class="image-wrapper pane" style="z-index: 0">
          <img src="images/form_dgm1.svg">
        </div>
      </div>


      <!-- Comments Pane -->
      <div id="comments" class="draggable-wrapper ui-draggable ui-draggable-handle">
        <div id="comments-toolbar" class="toolbar-pane"><p>Comments</p><img id="x_button_comments" class="x_button" src="images/visibility_on.svg"/></div>
        <div id="comments-pane" class="pane">
          <p class="comments-content">Comments appear here...</p>
        </div>
      </div>

    </body>
