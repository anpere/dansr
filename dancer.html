<head>
  <title>Dansr</title>
  <!--this is bootstrap if you want it-->
  <link rel="stylesheet" href= "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">

  <link rel="stylesheet" href="mainLayout.css">
  <link rel="stylesheet" href="video.css">
  <link rel="stylesheet" href="searchbar.css">
  <link rel="stylesheet" href="hamburger.css">
  <link rel="stylesheet" href="seekback.css">

  <link rel='shortcut icon' href='images/dfavicon.png'/>
  <meta charset="UTF-8">


  <!-- jQuery and jQueryUI -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="js/ui/jquery.ui.draggable.js" type="type/javascript"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  

  <script src="searchbar.js"></script>
  <script>
  /************************ Global Variables ********************/
  // TODO() replace as many as possible with functions.
  // i.e isLoopOn should be a function that reads the state of the loop button
  // as opposed to something we trust ourselves to modify correctly and consistently

  var secEnd = 1;
  var secStart = 0;
  var loop = false;
  var isLoopOn = false;

  // TODO() replace pause with isPlaying
  var pause = false;

  var isPlaying = false;
  var isMetronomeOn = false;

  var COUNTOFF_MIN=0;
  var COUNTOFF_MAX=30;
  var countoff = 0;

  /************************ Helper Functions ********************/

  // function that plays the video starting at percentage
  // percentage: integer in range [0,100] represents percentage into the video thot the video should be started at
  // returns: null
  loopVideoTo = function(percentage){
    var video = getVideo();
    console.log("looping video to " + percentage + "%... [video.duration = " + video.duration+"]");
    video.currentTime = (Math.abs(percentage)/100.) * video.duration;
  }

  // sets the speed of the video
  // speed: a positive  floating point number that represents the speed of video
  // i.e speed=.5 plays the video at half times speed, speed=2 plays at twice the speed
  setVideoSpeed = function(speed){
    console.log("setVideoSpeed: ")
    var video = getVideo();
    video.playbackRate = speed
  }

  // gets the length of the video in seconds
  getVideoDuration = function(){
    return getVideo().duration;
  }

  // get the currentTime of the video
  getVideoTime = function(){
    return getVideo().currentTime;
  }

  // return the width of the seekbar
  getSeekbarWidth = function(){
    return $('#seekback').width();
  }

  // get the video dom object
  getVideo = function(){
    return document.getElementById("videoBox");
  }

  // returns the string representation of countoff which is just
  // " (number)s"
  // note the preceding space
  // length of string is padded to 4 characters with a space
  countoffToString = function() {
    var toString = '&nbsp' + countoff + "s";
    if (countoff < 10){
      toString = '&nbsp' + '   ' + countoff + "s";
    }
    return toString;
  }

  /******************* Event Handlers *******************/
  // moves the indicator after pressing the play button
  this.playIndicator = function() {
    var rect = document.getElementById("seekbar").getBoundingClientRect();
    var handleStart = document.getElementById("sectionStart");
    var handleEnd = document.getElementById("sectionEnd");
    var speed = $("#speed").val();
    if (speed.length < 1) {
      speed = 1.0;
    } else {
      speed = parseFloat(speed);
    }

    // TODO: fix the handlebars so that they cannot cross each other
    console.log("play: " + secStart + "-" + secEnd + " " + handleStart.left);
    // if the video has not been paused, set the indicator to be at the left handlebar
    if (!pause) {
      $("#indicator").css({
        "left": handleStart.style.left
      });
    }
    // animate the indicator across the section
    $("#indicator").animate({
      "left": handleEnd.style.left
    }, getSeekbarWidth()*(getVideoTime()/getVideoDuration()), "linear");

    // at the end of the section, play it again if the loop is on
    setTimeout(function() {
      console.log("here");
      if (loop) {
        playIndicator();
      }
    }, getSeekbarWidth()*(getVideoTime()/getVideoDuration()) + 50);
  }

  $(document).ready(function() {
    // load all our html templates!
    $("#search").load("searchbar.html");
    $("#video").load("video.html");
    $("#seekback").load("seekback.html");

    countoff = this.value;

    // set initial positions of window panes
    $("#formations").css({position: "absolute", left: 30, top: 200});
    $("#comments").css({position: "absolute", left: 30, top: 300});

    // set countoff display
    //document.getElementById("countoff").innerHTML = "&nbsp15s";
    $("#countoff").innerHTML = "&nbsp15s";
    
    ////////////////// TODO: Figure out what this is supposed to do \\\\\\\\\\\\\\\\\\
    //var rect = document.getElementById("seekbar").getBoundingClientRect();
    //var rect = $("#seekbar")[0].getBoundingClientRect();
    //console.log("Bounding Client Rect: " + JSON.stringify(rect, null, 4));
    
    // Set all instances of .draggable-wrapper to be draggable in the body
    $('.draggable-wrapper').draggable({ containment: "body"});

    // Collapse / Expand window panes:
    // TODO: Merge into one listener?
    $('#x_button_form').on('mousedown', function(event) {
      $("#formation-image-wrapper").slideToggle('slow', function() {});
    });

    $('#x_button_comments').on('mousedown', function(event) {
      $("#comments-pane").slideToggle('slow', function() {});
    });

    //Draggable Indicator:
    //$(function() {
      $("#indicator").css({right: 0});
      $("#indicator").draggable({ axis: "x", containment: "parent", drag: function() {
          $("#indicator").stop();
          var width = $("#seekbar").width();
          console.log("event ", JSON.stringify($(this).offset(), null, 2));
        }
      });
    });
   /*   $(document).on("drag", "#indicator", function(event, ui) {
        $("#indicator").stop();
        var width = $("#seekbar").width();
        console.log("event ", JSON.stringify($(this).offset(), null, 2));
        //var fractionalPosition = Math.abs(ui.position.left / width);
        //loopVideoTo(fractionalPosition * 100.);
      });*/
    //});
  
    //Draggable Handlebars

    // prevents the movement of the indicator when dragging the handlebar
    $(document).on("mousedown", "#handlebarleft", function(event) {
      event.stopPropagation();
    });

    // creates the handler for dragging handlebars
    $("#handlebarleft").draggable({ axis: "x", containment: "parent"});
//});
    // updates the grey rectangles on the sides of the handlebar
    // DISCUSS: inverting the greyed out section?
    $(document).on("drag", "#handlebarleft", function(event, ui) {
    console.log("handlebarleft drag");
        console.log("event ", JSON.stringify(event, null, 2));
      var width = $("#seekbar").width();
      //var fractionalPosition = ui.position.left / width;
      if ($(this).attr("id") == "sectionEnd") {
        var handle = document.getElementById("sectionEnd").getBoundingClientRect();
        secEnd = fractionalPosition;
        $("#grayRight").css({"left": ui.position.left+20, "width": rect.right-handle.left-10});
      } else {
        secStart = fractionalPosition;
        $("#grayLeft").css({"width": ui.position.left});
      }
      event.stopPropagation();
    });
    
    seen = [];
    $(document).on("mousedown", "#seekbar", function(event) {
      JSON.stringify(event.delegateTarget, function(key, val) {
        if(val != null && typeof val == "object") {
          if(seen.indexOf(val) >= 0) {
            return;
          }
          seen.push(val);
        }
        return val;
      });
      
      var seekbarWidth = $("#seekbar").width();
      
      $("#indicator").stop();
      var clickedPosX_centered = event.clientX - $('#indicator').width()*1.0 - $("#seekback").offset().left;
      
      //Adjust to avoid glitches:
      if(clickedPosX_centered < 0) {
        clickedPosX_centered = 0;
      }
      else if(clickedPosX_centered > seekbarWidth) {
        clickedPosX_centered = seekbarWidth;
      }
      
      console.log("clickedPosX " + clickedPosX_centered + " seekbar width: " + $("#seekbar").width());
      $("#indicator").css({ left: /*-(seekbarWidth() -*/ clickedPosX_centered });
      loopVideoTo( clickedPosX_centered/seekbarWidth * 100.);
    });

  //});

  //Volume control
  //Draggable volumeIndicator:
  $(function() {

    /*$("#volumeIndicator").draggable({ axis: "x", containment: "parent"});
    $("#volumeIndicator").on("drag", function(event, ui) {
    console.log("volume");
      var width = $("#volumeBar").width();
      var fractionalPosition = ui.position.left / (width*1.0);
    });
//  });*/

    $("#volumeBar").mousedown(function(event) {
      var clickedPosX_centered = event.clientX - event.delegateTarget.offsetLeft - $('#volumeIndicator').width();
      //Adjust to 0 if negative to avoid glitches:
      if(clickedPosX_centered < 0) {
        clickedPosX_centered = 0;
      }
      /*$("#volumeIndicator").css({ position: 'relative',
      left: clickedPosX_centered });
      var volumeIndicator = $("#volumeIndicator");
      volumeIndicator.triggerHandler(event);
    });*/
  });
  });
  
  // toggles the loop variable depending on the state of the button
  $(document).on('click', "#loop", function(evt)
  {
    loop = !loop;
  });

  // back to beginning button - stops the indicator movement and plays again
  $(document).on('click', "#replay", function(evt)
  {
    $("#indicator").stop();
    playIndicator();
  });

  $(document).on('click', "#playPause", function(evt)
  {
    var button  = document.getElementById("playPause") // maybe this instead?
    if (!isPlaying){
      var video = document.getElementById("videoBox");
      video.play();
      isPlaying = true;
      playIndicator();
      pause = false;
      // set button to pause
      button.setAttribute("style", "background-image:url('images/pause.svg')")
    } else {
      var video = document.getElementById("videoBox");
      video.pause();
      $("#indicator").stop();
      pause = true;
      // set button to play
      button.setAttribute("style", "background-image:url('images/play.svg')")
      isPlaying = false;
    }
  });

  // snaps the handlebars to the section boundaries
  $(document).on('dblclick', ".section", function(evt) {
    var rect = document.getElementById("seekbar").getBoundingClientRect();
    var left = $(this).position().left;
    var right = left + $(this).width() - 20;
    var handle = document.getElementById("sectionEnd").getBoundingClientRect();
    secEnd = right / $("#seekbar").width();
    secStart = left / $("#seekbar").width();
    $("#grayRight").css({"left": right+20, "width": rect.right-handle.left-10});
    $("#grayLeft").css({"width": left});
  });

  $(document).on('mousemove', "#countoffBar", function(evt){
    // set countoff
    countoff = this.value;

    // set countoff display
    document.getElementById("countoff").innerHTML = countoffToString();
  })

  $( function() {
    $( "#slider" ).slider();
  } );

  //Toggles the metronome mode so that the button's background is blue when on, gray when off
  $(document).on('click', '#metronome', function (evt) {
    metronomeButton = document.getElementById("metronome");
    if (isMetronomeOn) {
      isMetronomeOn = false;
      metronomeButton.setAttribute("style", "background-image:url('images/metronome.svg');background-color:lightgray;");
    }
    else {
      isMetronomeOn = true;
      metronomeButton.setAttribute("style", "background-image:url('images/metronome.svg');background-color:#0275d8;border-color:#0275d8")
    }
  });

  //Toggles the loop mode so that the button's background is blue when on, gray when off
  $(document).on('click', '#loop', function (evt) {
    loopButton = document.getElementById("loop");
    if (isLoopOn) {
      isLoopOn = false;
      loopButton.setAttribute("style", "background-image:url('images/loop.svg');background-color:lightgray;");
    }
    else {
      isLoopOn = true;
      loopButton.setAttribute("style", "background-image:url('images/loop.svg');background-color:#0275d8;border-color:#0275d8")
    }
  });


  // decrements speed by 0.1
  $(document).on('click', "#left", function(evt) {
    var speed = $("#speed").val();
    if (speed.length < 1) {
      speed = 1.0;
    }
    speed = parseFloat(speed);
    var newSpeed = speed - 0.1;
    if (newSpeed <= 0) {
      return;
    }
    $("#speed").val(newSpeed.toFixed(1));
    setVideoSpeed(newSpeed);
  });

  // increments speed by 0.1
  $(document).on('click', "#right", function(evt) {
    var speed = $("#speed").val();
    if (speed.length < 1) {
      speed = 1.0;
    }
    speed = parseFloat(speed);
    var newSpeed = speed + 0.1;
    $("#speed").val(newSpeed.toFixed(1));
    setVideoSpeed(newSpeed)
  });

  // allow user to type into speed textbox
  $(document).on('keyup', "#speed", function(evt) {
    var speed = $("#speed").val();
    // TODO() more text validation: set min speed to .5 and max speed to 4.0
    if (isNaN(speed)) {
      $("#speed").val("1.0");
    }
    setVideoSpeed(speed);

  });

  // stops enter from submitting the page when focused on the speed textbox
  $(document).on('keypress', "#speed", function (e) {
    if (e.charCode==13) {
      return false;
    }
  });
  </script>
</head>


<body>
  <!-- <h1> This is an awesome Dancer interface</h1> -->
  <div id ="top">
    <!-- this is for the hamburger menu, logo, and watch/edit dance button-->
    <button id="hamburger">
      <img src="https://cdn4.iconfinder.com/data/icons/wirecons-free-vector-icons/32/menu-alt-512.png" width="30px" height="30px">
    </button>
    <a href="homepage.html" id="logo"><img src="images/dansrlogo.svg" height="40"/></a>

    <button class="btn" id="editDance" onclick="location.href='choreo.html'">
      <img src="images/edit.svg">
      <div id="editDanceText">
        Edit Dance
      </div>
    </button>
    <div id="search" class="ui-widget"></div>
  </div>

  <div id="content" style="max-width:999px; margin: 10% auto; margin-top:0px">

    <div id="video"></div>

    <div id ="seekback"></div>
    
  </div>

  <!-- Formation Diagram Pane-->
  <div id="formations" class="draggable-wrapper ui-draggable ui-draggable-handle">
    <div id="formation-toolbar" class="toolbar-pane"><p>Formation</p><p id="x_button_form" class="x_button">[__]</p></div>
    <div id="formation-image-wrapper" class="image-wrapper" style="z-index: 0">
      <img src="images/form_dgm1.svg">
    </div>
  </div>


  <!-- Comments Pane -->
  <div id="comments" class="draggable-wrapper ui-draggable ui-draggable-handle">
    <div id="comments-toolbar" class="toolbar-pane"><p>Comments</p><p id="x_button_comments" class="x_button">[__]</p></div>
    <div id="comments-pane">
      <p class="comments-content">Comments appear here...</p>
    </div>
  </div>



</body>
